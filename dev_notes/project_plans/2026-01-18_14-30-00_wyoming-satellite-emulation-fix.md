# Project Plan: Fix Wyoming Test Client for Proper Satellite Emulation

## Objective

Enable the Wyoming test client to correctly emulate real ESP32 satellite behavior by removing incorrect protocol usage and implementing auto-transcription on the server side. This fixes the protocol mismatch where the test client sends an unsupported `Transcribe` event before audio data, causing "Unhandled event type" errors and preventing proper voice assistant operation.

---

## Implementation Steps

### Phase 1: Client Fix - Remove Transcribe Event (wyoming_tester/cli.py)

1. **Remove unused imports** (Lines 81-82)
   - Remove: `Transcribe` from `wyoming.asr`
   - Remove: `RunPipeline, PipelineStage` from `wyoming.pipeline`
   - Retain imports: `AudioStart`, `AudioChunk`, `AudioStop`

2. **Update client documentation comment** (Line 109)
   - Change existing comment to: `"# Connect and send audio (satellite mode)"`
   - Add explanation comment: `"# Satellite protocol: Send audio events only. Server will automatically transcribe when AudioStop is received."`

3. **Remove Transcribe event sending block** (Lines 111-114)
   - Delete the following lines:
     ```python
     transcribe_event = Transcribe()
     client.send_event(transcribe_event)
     logger.info("Sent transcribe event")
     ```

4. **Verify result**
   - Client now only sends: `AudioStart` → `AudioChunk(s)` → `AudioStop`
   - This matches real ESP32 satellite behavior

### Phase 2: Server Enhancement - Auto-Transcription on AudioStop (server.py)

1. **Modify AudioStop handler** (Lines 138-142)
   - Add mode-specific logic that only activates in "full" mode
   - Add auto-transcription of buffered audio
   - Send `Transcript` event back to client

2. **Implement transcription logic**
   - Check if `self.mode == "full"` (satellite/voice assistant mode)
   - Verify `self.stt_service` is available
   - Call `self.stt_service.transcribe(bytes(self.audio_buffer))`
   - Wrap in try/except for error handling

3. **Process response through agent pipeline**
   - Send `Transcript` event to client via `await self.write_event(response_event)`
   - This triggers the existing `_process_transcript()` handler
   - Full pipeline: STT → LLM → TTS response

4. **Buffer management**
   - Clear audio buffer after successful transcription
   - Clear buffer in finally block even if errors occur
   - Prevent double-processing of audio data

5. **Logging enhancements**
   - Add debug log: "Auto-transcribing audio in satellite mode"
   - Add info log if debug enabled: "[timestamp] [WYOMING] Auto-transcribe triggered"
   - Log any transcription errors with full context

6. **Maintain backward compatibility**
   - "stt_only" mode: Keep existing behavior (wait for explicit Transcribe)
   - "combined" mode: Keep existing behavior (wait for explicit Transcribe)
   - "full" mode only: Enable auto-transcription

---

## Success Criteria

1. **No Protocol Errors**: Running `bash scripts/chat-demo.sh` produces no "Unhandled event type: Event" messages in logs
2. **Complete Pipeline**: Wyoming test client produces full STT → LLM → TTS flow
3. **Correct Event Sequence**: Server logs show:
   - ✓ AudioStart received
   - ✓ AudioChunk(s) received
   - ✓ AudioStop received
   - ✓ Auto-transcription triggered (in full mode)
   - ✓ Transcript sent back to client
   - ✓ No unhandled event messages
4. **Satellite Mode Works**: Client-server interaction matches real ESP32 satellite protocol
5. **Backward Compatibility**: Existing service-mode clients (stt_only, combined modes) still function correctly

---

## Testing Strategy

### Test 1: Protocol Error Verification
```bash
bash scripts/chat-demo.sh 2>&1 | grep -i "unhandled event"
```
**Expected Result**: No matches (no unhandled event errors)

### Test 2: End-to-End Pipeline Test
```bash
python -m wyoming_tester.cli --uri tcp://localhost:10700 --file tests/data/audio/test_audio.wav --verbose
```
**Expected Result**:
- Audio file is successfully transcribed
- Response is generated by LLM
- TTS synthesis completes
- No protocol errors

### Test 3: Server Log Verification
Check `tmp/chatterbox3b-server.log` for:
- All expected Wyoming events logged
- Auto-transcription triggered for AudioStop
- Transcript event sent to client
- No "Unhandled event" messages

### Test 4: Mode Verification
Test all server modes to verify backward compatibility:
- "stt_only" mode: Server transcribes on explicit Transcribe event only
- "combined" mode: Server transcribes on explicit Transcribe event only
- "full" mode: Server auto-transcribes on AudioStop

### Test 5: Integration with chat-demo
Verify that the demo script flows through complete pipeline without errors

---

## Risk Assessment

### Low Risk Areas
- **Removing unused imports**: No code depends on these imports; safe deletion
- **Removing Transcribe event from client**: This event was causing errors; removal fixes the issue
- **Adding mode-specific logic**: Only affects "full" mode; service modes remain unchanged

### Backward Compatibility
- Service mode clients (stt_only, combined) continue using explicit Transcribe events
- Mode-specific auto-transcription prevents breaking existing clients
- Audio buffer clearing prevents double-processing

### Error Scenarios
- **Missing STT service**: Check in try/except; log warning and return empty Transcript
- **Audio buffer empty**: Check buffer before transcribing; handle gracefully
- **Transcription failure**: Catch exception; log error; send empty Transcript to client

### Rollback Plan
If issues occur:
1. **Client rollback**: Add back 3 lines (Transcribe event import + sending + log)
2. **Server rollback**: Remove auto-transcription block in AudioStop handler
3. **Git revert**: Commit changes individually for easy reversal

---

## Notes

- This aligns the Wyoming test client with real ESP32 satellite behavior
- Server enhancement implements the "satellite mode" of the Wyoming protocol
- Changes maintain full backward compatibility with service-mode clients
- Protocol fix enables proper voice assistant operation through the ESP32 interface
