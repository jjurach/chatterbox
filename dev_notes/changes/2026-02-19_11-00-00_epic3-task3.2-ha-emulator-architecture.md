# Epic 3 Task 3.2: Home Assistant Emulator Architecture Design

**Status:** Completed
**Type:** ad-hoc (Research/Documentation)
**Date:** 2026-02-19
**Related Epic:** Epic 3 - Wyoming Protocol Implementation and Validation
**Related Plan:** dev_notes/project_plans/2026-02-18_epic-3-4-wyoming-llm-project-plan.md

---

## Summary

Completed Task 3.2 of Epic 3. Designed the Home Assistant emulator architecture
and created a comprehensive design document at `docs/ha-emulator-architecture.md`.

The design reuses existing `wyoming_tester` infrastructure (`WyomingClient`,
`AudioProcessor`) and introduces a new `ha_emulator` package with five distinct
layers: emulator, corpus loader, validator, test runner, and CLI.

---

## Changes Made

### New File: `docs/ha-emulator-architecture.md`

Created architecture design document covering:

- **Package structure** — `src/ha_emulator/` with 5 modules
- **`HAEmulator`** — High-level async orchestrator for STT, TTS, and full flows
- **`CorpusLoader`** — Loads test WAV files + `corpus.json` expected transcriptions
- **`ResultValidator`** — WER-based transcript validation; audio integrity checks
- **`TestRunner`** — Corpus iteration, report aggregation, JSON + stdout output
- **CLI** — `ha-emulator stt|tts|full|single-stt` commands
- **Data flow diagrams** — STT validation, TTS validation, full round-trip
- **Reuse decisions** — sync `WyomingClient` kept for `wyoming-tester`; async
  `asyncio.open_connection` used in `HAEmulator` for consistency
- **Testing strategy** — unit tests (mocked server) + integration tests (live server)
- **Known constraints** — TTS mock blocker, no connection pooling, CLI-only

### Updated: `dev_notes/project_plans/2026-02-18_epic-3-4-wyoming-llm-project-plan.md`

- Marked Task 3.2 as `Status: Completed (2026-02-19)`
- Updated Goal 2 status to `Architecture Designed (2026-02-19)`

---

## Architecture Decision: Async Client

The `HAEmulator` will use `asyncio.open_connection` (the async pattern from
`chatterbox.adapters.wyoming.client`) rather than the synchronous socket-based
`WyomingClient`. Rationale:

- Consistent with the rest of the codebase (`AsyncServer`, `AsyncEventHandler`)
- Enables future concurrent test execution (run multiple corpus entries in parallel)
- `wyoming-tester` CLI retains its sync `WyomingClient` for interactive use

---

## Architecture Decision: WER Threshold

Default acceptance threshold is WER ≤ 0.10 (≥90% word accuracy), matching the
Epic 3 Goal 4 acceptance criterion. The `ResultValidator` will make this
configurable so individual test runs can adjust the bar.

---

## Verification

Architecture design only; no executable code written. The document was reviewed
against:

- `src/wyoming_tester/protocol.py` — confirmed `WyomingClient` interface
- `src/wyoming_tester/audio.py` — confirmed `AudioProcessor` interface
- `src/chatterbox/adapters/wyoming/client.py` — confirmed async patterns
- `docs/wyoming-protocol.md` — confirmed event types and conversation flows
- Epic 3 acceptance criteria — all deliverables covered by design

---

## Known Issues

### TTS Mock Blocker (carried forward from Task 3.1)

`PiperTTSService.synthesize()` returns `b'\x00' * 160`. The emulator
architecture accounts for this: TTS validation (Task 3.7) is listed as a
separate task and the architecture document notes this constraint explicitly.

**Must be resolved before Task 3.7.** Recommended fix: wire `PiperTTSService`
to the real ONNX model during Task 3.4 or as a dedicated pre-Task-3.7 fix.

---

## Definition of Done Compliance

- [x] Architecture document created at `docs/ha-emulator-architecture.md`
- [x] Component architecture clearly defined (5 modules)
- [x] Data flow diagrams included for all 3 test modes
- [x] Testing strategy documented
- [x] Reuse decisions documented
- [x] Known constraints documented
- [x] File uses lowercase-kebab.md naming convention
- [x] Project plan updated (Task 3.2 marked Completed)
- [x] Change log created with ad-hoc status
- [x] No code changes made (documentation only)

---

## Next Steps (Epic 3 Tasks 3.3 and 3.4)

Both tasks are now unblocked:

- **Task 3.3** — Create test wave corpus (10–15 WAV files + `corpus.json`)
- **Task 3.4** — Implement `ha_emulator` package following this architecture

Task 3.3 can proceed in parallel with Task 3.4. The corpus is needed by the
`CorpusLoader` which is the first component exercised in integration tests.
