# Task 4.2: Select and Evaluate Agentic Framework

**Status:** Completed
**Date:** 2026-02-20
**Epic:** Epic 4 — LLM Integration with Tool Calling
**Type:** Research + Implementation (skeleton/POC)
**Project Plan:** `dev_notes/project_plans/2026-02-20_00-20-16_task-4.2-agentic-framework-evaluation.md`

---

## Summary

Evaluated agentic framework options for the HA ConversationEntity integration pattern
identified in Task 4.1. Selected a **custom minimal async tool-calling loop** using the
OpenAI SDK. Created the initial `chatterbox.conversation` package implementing that
design. 24 unit tests written and passing.

---

## Framework Decision

**Selected: Custom Minimal Async Loop (OpenAI SDK)**

Options evaluated:

| Framework | Verdict | Reason |
|---|---|---|
| LangChain Classic (existing `agent.py`) | ❌ Not suitable | Synchronous, legacy API, not async-native |
| LangGraph (1.0.7 installed) | ⚠️ Overkill | Graph model adds complexity for a linear tool loop |
| Custom loop (OpenAI SDK 2.16.0) | ✅ **Selected** | Async-native, simple, testable, OpenAI-compatible |
| Raw Anthropic SDK | ❌ Not suitable | Not installed, vendor-locked, no Ollama support |

Rationale: The HA ConversationEntity's `async_process()` method runs a linear tool-calling
loop (call LLM → dispatch tools → repeat → return). This is well-understood and does
not need a graph framework. The OpenAI SDK already works with Ollama, OpenAI, and
Claude proxies. LangGraph remains available as a future option for multi-agent scenarios.

Full evaluation: `docs/agentic-framework-evaluation.md`

---

## Files Changed

### New Files
- `docs/agentic-framework-evaluation.md` — Framework evaluation document
- `dev_notes/project_plans/2026-02-20_00-20-16_task-4.2-agentic-framework-evaluation.md` — Project plan
- `src/chatterbox/conversation/__init__.py` — Package exports
- `src/chatterbox/conversation/providers.py` — `LLMProvider` Protocol + `OpenAICompatibleProvider`
- `src/chatterbox/conversation/loop.py` — `AgenticLoop` (the tool-calling engine)
- `src/chatterbox/conversation/entity.py` — `ChatterboxConversationEntity` skeleton
- `tests/unit/test_conversation/__init__.py`
- `tests/unit/test_conversation/test_loop.py` — 8 unit tests
- `tests/unit/test_conversation/test_entity.py` — 9 unit tests
- `tests/unit/test_conversation/test_providers.py` — 7 unit tests

### Modified Files
- `pyproject.toml` — Added `chatterbox.conversation` to packages list

---

## Architecture: `chatterbox.conversation`

```
chatterbox.conversation/
├── providers.py
│   ├── ToolDefinition  — Tool schema (OpenAI format)
│   ├── ToolCall        — Tool invocation from LLM
│   ├── CompletionResult — LLM response (stop or tool_calls)
│   ├── LLMProvider      — Protocol (duck-typed interface)
│   └── OpenAICompatibleProvider — Wraps openai.AsyncOpenAI
├── loop.py
│   └── AgenticLoop     — While-loop: call LLM → dispatch → repeat → return
└── entity.py
    ├── ConversationInput  — Mirrors HA's ConversationInput
    ├── ConversationResult — Mirrors HA's ConversationResult
    └── ChatterboxConversationEntity — Owns AgenticLoop + in-memory history
```

The loop:
```python
while iteration < max_iterations:
    result = await provider.complete(messages, tools)
    if result.finish_reason == "stop":
        return result.content
    # dispatch tool calls, feed results back
    messages += [assistant_msg, *tool_result_msgs]
```

---

## Verification Results

### Command
```
/home/phaedrus/hentown/tools/venv/bin/pytest tests/unit/test_conversation/ -v
```

### Output (abbreviated)
```
collected 24 items

test_entity.py::test_async_process_returns_conversation_result[asyncio] PASSED
test_entity.py::test_async_process_passes_user_text_to_loop[asyncio] PASSED
test_entity.py::test_async_process_echoes_conversation_id[asyncio] PASSED
test_entity.py::test_async_process_no_conversation_id_returns_none[asyncio] PASSED
test_entity.py::test_multi_turn_history_accumulated[asyncio] PASSED
test_entity.py::test_sessions_are_isolated[asyncio] PASSED
test_entity.py::test_clear_history_removes_session[asyncio] PASSED
test_entity.py::test_clear_all_history[asyncio] PASSED
test_entity.py::test_tools_passed_to_loop[asyncio] PASSED
test_loop.py::test_run_returns_text_on_stop[asyncio] PASSED
test_loop.py::test_run_includes_system_prompt_in_messages[asyncio] PASSED
test_loop.py::test_run_includes_chat_history[asyncio] PASSED
test_loop.py::test_run_dispatches_single_tool_call[asyncio] PASSED
test_loop.py::test_run_handles_multiple_tool_iterations[asyncio] PASSED
test_loop.py::test_run_handles_tool_dispatcher_exception[asyncio] PASSED
test_loop.py::test_run_raises_on_max_iterations_exceeded[asyncio] PASSED
test_loop.py::test_run_passes_tool_definitions_to_provider[asyncio] PASSED
test_providers.py::test_tool_definition_to_openai_format PASSED
test_providers.py::test_tool_definition_empty_parameters PASSED
test_providers.py::test_tool_call_dataclass PASSED
test_providers.py::test_completion_result_stop PASSED
test_providers.py::test_completion_result_tool_calls PASSED
test_providers.py::test_openai_compatible_provider_implements_protocol PASSED
test_providers.py::test_openai_compatible_provider_stores_config PASSED

24 passed, 1 warning in 2.06s
```

### Full unit suite (chatterbox venv)
```
/home/phaedrus/hentown/modules/chatterbox/venv/bin/pytest tests/unit/ -v
# Result: 69 passed, 3 warnings (45 existing + 24 new)
```

---

## Known Issues / Follow-On

- `ChatterboxConversationEntity` is a skeleton — it mirrors HA's `ConversationEntity`
  interface but does not subclass the real HA class. Integration with HA's actual
  `ConversationEntity` and `llm.async_get_api()` is Task 4.11.
- In-memory chat history is per-process and not persisted. Epic 4.8/4.9 covers context
  management evaluation.
- `agent.py` (LangChain Classic) remains in place for existing CLI usage. It should
  NOT be extended for Epic 4 work; the new `conversation/` package is the correct path.

---

## Next Task

**Task 4.3:** Design Agentic Loop State Machine
- Defines all conversation states and transitions for the full Epic 4 implementation
- Builds on the `AgenticLoop` and `ChatterboxConversationEntity` skeleton from this task
