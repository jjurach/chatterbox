# Change Documentation: Epic 3 Task 3.5 — Emulator Validation Framework Tests

**Date:** 2026-02-19
**Task:** Epic 3 Task 3.5 — Implement Emulator Validation Framework
**Status:** Completed

---

## Summary

Task 3.5 required adding validation and reporting capabilities to the `ha_emulator` package. The core implementation (`validator.py`, `runner.py`, `cli.py`) was already delivered as part of Task 3.4. This change adds the unit test suite that completes the Task 3.5 definition of done.

---

## Changes Made

### New File: `tests/test_ha_emulator.py`

47 unit tests covering:

| Module | Class / Function | Tests |
|--------|-----------------|-------|
| `validator.py` | `_normalize` | 4 |
| `validator.py` | `_wer` | 6 |
| `validator.py` | `ResultValidator.validate_transcript` | 8 |
| `validator.py` | `ResultValidator.validate_audio` | 7 |
| `validator.py` | `ResultValidator.save_audio` | 2 |
| `runner.py` | `_build_report` | 3 |
| `runner.py` | `TestRunner.run_stt_suite` | 3 |
| `runner.py` | `TestRunner.run_tts_suite` | 3 |
| `runner.py` | `TestRunner.run_full_suite` | 2 |
| `runner.py` | `TestRunner.print_report` | 1 |
| `runner.py` | `TestRunner.save_report` | 1 |
| `corpus.py` | `CorpusLoader` | 7 |

---

## Verification

```
pytest tests/test_ha_emulator.py -v
```

```
============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2
collected 47 items

tests/test_ha_emulator.py::TestNormalize::test_lowercases PASSED
tests/test_ha_emulator.py::TestNormalize::test_strips_punctuation PASSED
tests/test_ha_emulator.py::TestNormalize::test_empty_string PASSED
tests/test_ha_emulator.py::TestNormalize::test_only_punctuation PASSED
tests/test_ha_emulator.py::TestWer::test_identical PASSED
tests/test_ha_emulator.py::TestWer::test_completely_different PASSED
tests/test_ha_emulator.py::TestWer::test_one_insertion PASSED
tests/test_ha_emulator.py::TestWer::test_empty_reference_empty_hypothesis PASSED
tests/test_ha_emulator.py::TestWer::test_empty_reference_nonempty_hypothesis PASSED
tests/test_ha_emulator.py::TestWer::test_empty_hypothesis PASSED
tests/test_ha_emulator.py::TestValidateTranscript::test_exact_match PASSED
tests/test_ha_emulator.py::TestValidateTranscript::test_case_insensitive PASSED
tests/test_ha_emulator.py::TestValidateTranscript::test_punctuation_ignored PASSED
tests/test_ha_emulator.py::TestValidateTranscript::test_one_word_error_within_tolerance PASSED
tests/test_ha_emulator.py::TestValidateTranscript::test_high_wer_fails PASSED
tests/test_ha_emulator.py::TestValidateTranscript::test_score_bounded PASSED
tests/test_ha_emulator.py::TestValidateTranscript::test_details_contains_expected_and_actual PASSED
tests/test_ha_emulator.py::TestValidateTranscript::test_returns_validation_result PASSED
tests/test_ha_emulator.py::TestValidateAudio::test_valid_audio_passes PASSED
tests/test_ha_emulator.py::TestValidateAudio::test_empty_bytes_fails PASSED
tests/test_ha_emulator.py::TestValidateAudio::test_too_short_fails PASSED
tests/test_ha_emulator.py::TestValidateAudio::test_invalid_rate_fails PASSED
tests/test_ha_emulator.py::TestValidateAudio::test_invalid_width_fails PASSED
tests/test_ha_emulator.py::TestValidateAudio::test_invalid_channels_fails PASSED
tests/test_ha_emulator.py::TestValidateAudio::test_valid_stereo PASSED
tests/test_ha_emulator.py::TestSaveAudio::test_saves_wav_file PASSED
tests/test_ha_emulator.py::TestSaveAudio::test_creates_parent_dirs PASSED
tests/test_ha_emulator.py::TestBuildReport::test_empty PASSED
tests/test_ha_emulator.py::TestBuildReport::test_all_pass PASSED
tests/test_ha_emulator.py::TestBuildReport::test_some_fail PASSED
tests/test_ha_emulator.py::TestTestRunnerSTT::test_stt_suite_all_pass PASSED
tests/test_ha_emulator.py::TestTestRunnerSTT::test_stt_suite_connection_failure PASSED
tests/test_ha_emulator.py::TestTestRunnerSTT::test_stt_suite_transcript_mismatch PASSED
tests/test_ha_emulator.py::TestTestRunnerTTS::test_tts_suite_all_pass PASSED
tests/test_ha_emulator.py::TestTestRunnerTTS::test_tts_suite_connection_failure PASSED
tests/test_ha_emulator.py::TestTestRunnerTTS::test_tts_suite_invalid_audio PASSED
tests/test_ha_emulator.py::TestTestRunnerFull::test_full_suite_pass PASSED
tests/test_ha_emulator.py::TestTestRunnerFull::test_full_suite_stt_failure PASSED
tests/test_ha_emulator.py::TestReporting::test_print_report_runs PASSED
tests/test_ha_emulator.py::TestReporting::test_save_report_json PASSED
tests/test_ha_emulator.py::TestCorpusLoader::test_load_all PASSED
tests/test_ha_emulator.py::TestCorpusLoader::test_missing_directory PASSED
tests/test_ha_emulator.py::TestCorpusLoader::test_missing_manifest PASSED
tests/test_ha_emulator.py::TestCorpusLoader::test_missing_wav_skipped PASSED
tests/test_ha_emulator.py::TestCorpusLoader::test_load_entry_by_stem PASSED
tests/test_ha_emulator.py::TestCorpusLoader::test_load_entry_not_found PASSED
tests/test_ha_emulator.py::TestCorpusLoader::test_sorted_by_filename PASSED

======================== 47 passed, 4 warnings in 0.09s ========================
```

---

## Definition of Done — Task 3.5

- [x] Can validate text transcriptions against expected (WER-based, `ResultValidator.validate_transcript`)
- [x] Can save received audio as wave files (`ResultValidator.save_audio`)
- [x] Can run full test suite automatically (`TestRunner.run_stt_suite`, `run_tts_suite`, `run_full_suite`)
- [x] Generates clear pass/fail reports (`TestRunner.print_report`, `save_report`)
- [x] Unit tests pass (47/47)

---

## Known Issues

- `PiperTTSService.synthesize()` returns a 160-byte mock buffer. TTS round-trip validation will require a live Piper service (addressed in Task 3.7).
