# Change Log: Epic 3 Task 3.4 — Implement Home Assistant Emulator Core

**Date:** 2026-02-19
**Task:** 3.4 — Implement Home Assistant Emulator Core
**Epic:** Epic 3 — Wyoming Protocol Implementation and Validation
**Status:** Complete

---

## Summary

Implemented the `ha_emulator` Python package — a test harness that drives
Chatterbox Wyoming services the same way Home Assistant would in production.
The emulator enables repeatable, automated validation of STT, TTS, and full
round-trip flows without requiring a live Home Assistant instance.

---

## Files Created

### Package

| File | Description |
|---|---|
| `src/ha_emulator/__init__.py` | Package entry point; re-exports public API |
| `src/ha_emulator/emulator.py` | `HAEmulator` — async orchestrator for STT/TTS/full flows |
| `src/ha_emulator/corpus.py` | `CorpusLoader` — loads wave files + expected text from corpus |
| `src/ha_emulator/validator.py` | `ResultValidator` — WER transcript validation, audio format check |
| `src/ha_emulator/runner.py` | `TestRunner` — iterates corpus, aggregates pass/fail reports |
| `src/ha_emulator/cli.py` | `ha-emulator` CLI entry point |

### Unit Tests

| File | Tests |
|---|---|
| `tests/unit/test_corpus.py` | 9 tests — CorpusLoader load/sort/error paths |
| `tests/unit/test_emulator.py` | 6 tests — HAEmulator STT/TTS/full flows (mocked server) |
| `tests/unit/test_validator.py` | 22 tests — WER math, transcript/audio validation |
| `tests/unit/test_runner.py` | 8 tests — report aggregation, JSON serialization, suite runners |
| `tests/unit/__init__.py` | Package marker |

### pyproject.toml

- Added `ha_emulator` to `[tool.setuptools] packages`
- Added `ha_emulator = "src/ha_emulator"` to `[tool.setuptools.package-dir]`
- Added `ha-emulator = "ha_emulator.cli:main"` to `[project.scripts]`

---

## Key Design Decisions

1. **Async-first** — All protocol I/O uses `asyncio.open_connection` +
   Wyoming's `async_read_event` / `async_write_event`, consistent with the
   existing codebase.
2. **One connection per operation** — Follows Wyoming's expected
   one-TCP-connection-per-conversation pattern (no pooling).
3. **stdlib WAV only** — `_read_wav` and `_save_wav` use Python's stdlib
   `wave` module (no `pydub` dependency in the emulator itself) for simplicity.
4. **WER via DP** — `_wer()` in `validator.py` uses Wagner–Fischer dynamic
   programming; no external ASR library required.
5. **TTS mock awareness** — `PiperTTSService.synthesize()` currently returns
   a 160-byte mock buffer. TTS validation will fail until Task 3.7 resolves
   this (noted in `ha-emulator-architecture.md` Known Issues).

---

## Test Results

```
$ python -m pytest tests/unit/ -v
=================== 45 passed, 3 warnings in 0.10s ===================
```

All 45 unit tests pass.

---

## CLI Usage Examples

```bash
# Run STT suite against corpus
ha-emulator stt --corpus tests/corpus/ --host localhost --port 10700

# Synthesize a single text string
ha-emulator tts "Hello world" --output /tmp/out.wav --host localhost --port 10700

# Full round-trip suite
ha-emulator full --corpus tests/corpus/ --report /tmp/report.json

# Single WAV transcription with expected text validation
ha-emulator single-stt tests/corpus/test_001_turn_on_lights.wav \
    --expected "turn on the lights"
```

---

## Verification Commands

```bash
# Install and verify CLI is registered
pip install -e .
ha-emulator --help

# Run unit tests
python -m pytest tests/unit/ -v

# Import check
python -c "from ha_emulator import HAEmulator, CorpusLoader, ResultValidator, TestRunner; print('OK')"
```

---

## Next Task

**Task 3.5: Implement Emulator Validation Framework** — add integration-level
test infrastructure that can run the emulator against a live Chatterbox server.
