# Task 4.1: Research and Document Home Assistant Conversation Flow

**Status:** Completed
**Date:** 2026-02-20
**Bead:** chatterbox-cb0.1
**Epic:** Epic 4 — LLM Integration with Tool Calling
**Type:** Research/Documentation (ad-hoc)

---

## Summary

Researched the Home Assistant voice assistant pipeline to understand exactly how
HA connects STT, Conversation Agents, and TTS, and where Chatterbox's LLM integration
should fit in Epic 4.

---

## Key Findings

### 1. Wyoming Protocol Scope

Wyoming is used **only** for STT, TTS, and wake word detection. It is **not** used
for the conversation/LLM layer. This is a critical architectural clarification that
changes how Epic 4 should be designed.

### 2. HA Assist Pipeline Stages

```
Wake Word (Wyoming) → STT (Wyoming) → Conversation Agent (HA integration) → TTS (Wyoming) → Audio
```

The Conversation Agent is an HA integration abstraction (`ConversationEntity`), not
a Wyoming service. OpenAI, Google, and Ollama are all implemented as Conversation
Entities, not as Wyoming endpoints.

### 3. Three Integration Patterns Evaluated

| Pattern | Where LLM Lives | Wyoming Role | HA Visibility |
|---|---|---|---|
| A — Custom Conversation Agent | Inside Chatterbox HA integration | STT/TTS only | Full (pipeline, history, UI) |
| B — Satellite-level LLM | Inside the satellite firmware | STT/TTS/audio | None |
| C — Combined Wyoming Endpoint | Inside Chatterbox Wyoming server | Full audio loop | Partial |

### 4. Architectural Decision: Pattern A

Pattern A (Custom HA Conversation Agent) is recommended for Epic 4:

- Correct HA integration pattern — uses the same API as OpenAI/Ollama
- HA LLM API helper automatically exposes all HA intents as tools (device control)
- HA UI visibility for conversation history and pipeline stats
- Simpler than reimplementing device control from scratch via HA REST API
- Easier to test in isolation

---

## Deliverables Created

- `docs/ha-conversation-flow.md` — Complete conversation flow documentation, three
  integration patterns, architectural decision, and HA pipeline event flow detail

---

## Impact on Epic 4 Task Plan

The Epic 4 task structure from the project plan is still valid, but with a clarification:

- **Tasks 4.2–4.4** (framework selection, state machine, agentic loop) remain the same
- **Task 4.5** (weather tool) remains the same
- **Task 4.11** (Wyoming integration) is now clearer: Wyoming is NOT the integration
  point for the LLM — instead, a custom `ConversationEntity` is the integration point.
  Task 4.11 should be renamed/scoped to "Implement Custom HA Conversation Entity."

The task bead IDs and structure are unchanged; the understanding of *where* the LLM
hooks into HA is now clarified.

---

## Verification

Research was conducted via:

1. Home Assistant official documentation (wyoming, voice pipelines, conversation entity)
2. HA developer docs (Assist pipelines API, custom conversation agent, LLM API)
3. Community resources (FutureProofHomes wyoming-enhancements as reference for Pattern B)

No code was written for this task (research/documentation only).

---

## Known Issues / Follow-On

- Device control tools (HA intents via LLM API helper) require the HA integration to
  be loaded inside a running HA instance — cannot be easily tested in pure unit tests.
  Epic 4 should include integration tests that spin up a minimal HA instance, or use
  mocking to approximate the LLM API helper surface.
- Pattern B (satellite-level LLM) remains viable for offline/standalone use cases and
  may be worth revisiting as an Epic 5 option.

---

## References

- [Assist Pipelines Dev Docs](https://developers.home-assistant.io/docs/voice/pipelines/)
- [Conversation Entity Dev Docs](https://developers.home-assistant.io/docs/core/conversation/custom_agent/)
- [HA LLM API](https://developers.home-assistant.io/docs/core/llm/)
- [docs/ha-conversation-flow.md](../docs/ha-conversation-flow.md)
