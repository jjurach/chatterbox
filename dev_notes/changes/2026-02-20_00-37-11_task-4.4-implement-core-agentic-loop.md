# Task 4.4: Implement Core Agentic Loop

**Status:** Completed
**Date:** 2026-02-20
**Epic:** Epic 4 — LLM Integration with Tool Calling

## Summary

Fleshed out the agentic loop implementation per the Task 4.3 design specification:

1. **Error handling in `async_process`** — Added try/except in `ChatterboxConversationEntity.async_process` to catch `RuntimeError` (max_iterations exceeded) and unexpected exceptions (e.g. LLM API failures). Both return graceful text responses to the caller rather than propagating exceptions to the TTS pipeline. History is not updated on a failed turn.

2. **Edge-case unit tests** — Added 10 new tests (4 in `test_entity.py`, 6 in `test_loop.py`) to cover previously untested edge cases.

## Files Changed

### `src/chatterbox/conversation/entity.py`

- Wrapped `self._loop.run(...)` in try/except:
  - `RuntimeError` → logs error, returns "I'm sorry, I got stuck trying to answer that. Please try again."
  - `Exception` → logs error with `exc_info=True`, returns "I'm sorry, I encountered an error. Please try again."
- History is only updated on **successful** turns; failed turns leave history unchanged.

### `tests/unit/test_conversation/test_entity.py`

Added 4 tests:
- `test_async_process_handles_runtime_error_gracefully` — RuntimeError → "sorry" in response
- `test_async_process_handles_unexpected_exception_gracefully` — ConnectionError → "sorry" in response
- `test_history_not_updated_on_loop_error` — history stays at 2 entries after a failed second turn
- `test_error_response_echoes_conversation_id` — conversation_id still echoed in error response

### `tests/unit/test_conversation/test_loop.py`

Added 6 tests:
- `test_run_does_not_mutate_chat_history` — caller's list is never modified
- `test_run_returns_empty_string_for_none_content` — None content on stop → ""
- `test_run_handles_unexpected_finish_reason` — "content_filter" → returns content, no crash
- `test_run_handles_tool_calls_finish_reason_with_empty_calls` — tool_calls with empty list falls to unexpected branch
- `test_run_dispatches_multiple_tool_calls_in_one_response` — batch tool calls all dispatched
- `test_run_without_system_prompt_omits_system_message` — no system message when prompt is None

## Verification Results

### Command

```bash
/home/phaedrus/hentown/modules/chatterbox/venv/bin/pytest tests/unit/ -v --tb=short -q
```

### Output

```
======================== 79 passed, 3 warnings in 2.05s =========================
```

Previously: 69 unit tests (45 emulator/corpus/validator + 24 conversation).
After Task 4.4: 79 unit tests (69 + 10 new edge-case tests).

All 79 pass with the chatterbox venv. The tools venv has 9 pre-existing failures in
`test_emulator.py` / `test_runner.py` (async plugin mismatch, not caused by this task).

## Known Issues

None. The 9 pre-existing failures in the tools venv (`test_emulator.py`, `test_runner.py`)
are unchanged from before this task — they pass with the chatterbox venv.

## Design Invariants Preserved

- `AgenticLoop` remains stateless — no changes to `loop.py`.
- Error recovery is the **entity's** responsibility; the loop still propagates exceptions.
- History is never updated on a failed turn, preserving session integrity.
