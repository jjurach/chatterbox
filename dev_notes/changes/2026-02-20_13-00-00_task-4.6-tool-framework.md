# Task 4.6 — Tool Framework Implementation

**Date:** 2026-02-20
**Status:** Completed
**Epic:** 4 — LLM Integration with Tool Calling

---

## Summary

Implemented the extensible tool framework for the Chatterbox agentic loop.
Adds `ToolRegistry` (tool registration + dispatcher factory with timeout and
retry support) and `DateTimeTool` (second reference tool alongside
`WeatherTool`).

---

## Changes

### New Files

| File | Description |
|------|-------------|
| `src/chatterbox/conversation/tools/registry.py` | `ToolRegistry` class — registration, introspection, and `build_dispatcher()` |
| `src/chatterbox/conversation/tools/datetime_tool.py` | `DateTimeTool` — returns current date/time with optional IANA timezone |
| `tests/unit/test_conversation/test_tools/test_registry.py` | 20 tests for `ToolRegistry` |
| `tests/unit/test_conversation/test_tools/test_datetime_tool.py` | 21 tests for `DateTimeTool` |

### Modified Files

| File | Change |
|------|--------|
| `src/chatterbox/conversation/tools/__init__.py` | Added exports for `ToolRegistry`, `AsyncToolHandler`, `DateTimeTool` |

---

## Architecture

### ToolRegistry

```
ToolRegistry
├── register(definition, handler)         # maps name → (ToolDefinition, AsyncToolHandler)
├── deregister(name)                       # removes tool
├── get_definitions() → list[ToolDefinition]  # for AgenticLoop.run()
├── __len__() / __contains__(name)        # introspection
└── build_dispatcher(                     # produces AgenticLoop.tool_dispatcher
        timeout=30.0,                     #   asyncio.wait_for() per call
        max_retries=0,                    #   additional retry attempts
        retry_exceptions=(TimeoutError,)  #   which exceptions to retry
    ) → async (name, args) -> str
```

**Design decisions:**
- `build_dispatcher()` takes a **snapshot** of the registry at call time;
  tools registered after the snapshot are not visible to that dispatcher.
  This prevents race conditions if the registry is mutated during a
  conversation.
- Unknown tool names return `{"error": "Unknown tool: ..."}` JSON rather
  than raising, matching the pattern used by `WeatherTool.as_dispatcher_entry()`.
- Non-retryable exceptions propagate so `AgenticLoop._dispatch_tool_calls()`
  can record the full traceback.

### DateTimeTool

- No external API — uses Python's `datetime` stdlib and `zoneinfo` (3.9+).
- Returns: `datetime_iso`, `date`, `time`, `timezone`, `day_of_week`,
  `unix_timestamp`.
- Unknown timezone names fall back to UTC and add `"error"` field in result.
- Follows the same pattern as `WeatherTool`: `TOOL_DEFINITION` class attribute
  + `as_dispatcher_entry()` method.

---

## Usage Example

```python
from chatterbox.conversation.tools import ToolRegistry, WeatherTool, DateTimeTool
from chatterbox.conversation.loop import AgenticLoop
from chatterbox.conversation.providers import OpenAICompatibleProvider

registry = ToolRegistry()

weather = WeatherTool()
registry.register(WeatherTool.TOOL_DEFINITION, weather.as_dispatcher_entry())

dt = DateTimeTool()
registry.register(DateTimeTool.TOOL_DEFINITION, dt.as_dispatcher_entry())

provider = OpenAICompatibleProvider()
loop = AgenticLoop(
    provider=provider,
    tool_dispatcher=registry.build_dispatcher(timeout=10.0, max_retries=1),
)
response = await loop.run(
    user_text="What time is it in Tokyo?",
    chat_history=[],
    tools=registry.get_definitions(),
)
```

---

## Test Results

```
147 passed in 2.28s
```

- 20 new `test_registry.py` tests (registration, dispatcher, timeout, retry)
- 21 new `test_datetime_tool.py` tests (TOOL_DEFINITION shape, UTC, timezones,
  dispatcher entry)
- All 106 pre-existing unit tests continue to pass

---

## Definition of Done Checklist

- [x] Multiple tools can be registered
- [x] Tools invoked correctly by dispatcher
- [x] Timeout mechanism works (asyncio.wait_for)
- [x] Retry logic works (configurable exception types + max_retries)
- [x] Unknown tool returns error JSON (no crash)
- [x] Snapshot semantics prevent post-build mutations from affecting dispatcher
- [x] Second tool implemented (DateTimeTool)
- [x] All 41 new tests pass; 0 regressions
- [x] Change doc written
