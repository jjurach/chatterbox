# Task 4.5 — Implement Weather Tool

**Date:** 2026-02-20
**Status:** Completed
**Epic:** Epic 4 — LLM Integration with Tool Calling

## Summary

Implemented the `WeatherTool` — the first concrete tool for the Chatterbox
agentic loop. The tool fetches current weather conditions using the
[Open-Meteo API](https://open-meteo.com/), which is free and requires no API
key.

## Changes

### New Files

| File | Description |
|------|-------------|
| `src/chatterbox/conversation/tools/__init__.py` | `tools` sub-package; exports `WeatherTool` |
| `src/chatterbox/conversation/tools/weather.py` | `WeatherTool` implementation |
| `tests/unit/test_conversation/test_tools/__init__.py` | Test package marker |
| `tests/unit/test_conversation/test_tools/test_weather.py` | 27 unit tests |

### Modified Files

| File | Change |
|------|--------|
| `src/chatterbox/conversation/__init__.py` | Added `WeatherTool` import and `__all__` entry |

## Architecture

The tool follows a two-step pattern:

1. **Geocoding** — Resolves a human-readable location string to latitude/longitude
   using the Open-Meteo geocoding endpoint.
2. **Conditions fetch** — Retrieves current conditions (temperature, humidity,
   wind, weather code) for those coordinates.

WMO weather codes are mapped to human-readable descriptions via a lookup table
(`_WMO_CONDITIONS`).

### `WeatherTool` public surface

```python
class WeatherTool:
    TOOL_DEFINITION: ToolDefinition   # ready for AgenticLoop.run(tools=[...])

    async def get_weather(self, location: str) -> dict:
        # Returns: location_name, temperature_c, temperature_f,
        #          conditions, humidity_percent, wind_speed_kmh, wind_speed_mph

    def as_dispatcher_entry(self):
        # Returns async callable (args: dict) -> JSON str
        # Catches ValueError, HTTPStatusError, TimeoutException — returns JSON error
```

### Integration with AgenticLoop

```python
from chatterbox.conversation import AgenticLoop, WeatherTool

weather = WeatherTool()
handlers = {"get_weather": weather.as_dispatcher_entry()}

async def dispatcher(name, args):
    handler = handlers.get(name)
    if handler is None:
        return json.dumps({"error": f"Unknown tool: {name}"})
    return await handler(args)

loop = AgenticLoop(provider=provider, tool_dispatcher=dispatcher)
response = await loop.run(
    user_text="What is the weather in Kansas City?",
    chat_history=[],
    tools=[WeatherTool.TOOL_DEFINITION],
)
```

## API Endpoints Used

- **Geocoding:** `https://geocoding-api.open-meteo.com/v1/search`
- **Weather:**  `https://api.open-meteo.com/v1/forecast`

Both are free, no API key required, global coverage.

## Test Coverage

27 unit tests in `tests/unit/test_conversation/test_tools/test_weather.py`:

- `TOOL_DEFINITION` structure and OpenAI format serialisation
- Successful weather fetch (keys, location name, temperature conversion, WMO codes, wind speed)
- Error paths: location not found, HTTP errors (geo + weather), timeout
- `as_dispatcher_entry`: success, missing arg, not found, HTTP error, timeout
- WMO condition code coverage
- Location name edge cases (missing admin1)
- Humidity cast to int

**Test results:** 27/27 passed; full suite 106/106 passed (no regressions).

## Definition of Done Verification

- [x] Implementation correct and complete
- [x] All unit tests pass (27 new, 106 total)
- [x] No regressions
- [x] `TOOL_DEFINITION` ready for `AgenticLoop`
- [x] `as_dispatcher_entry()` handles all error cases gracefully
- [x] Docstrings present
- [x] Type hints throughout
- [x] Change doc written
- [x] Project plan status updated (see below)

## Project Plan Status Update

Update `dev_notes/project_plans/2026-02-18_epic-3-4-wyoming-llm-project-plan.md`:
- Task 4.5: **Completed** (2026-02-20)
- Next task: **4.6** — Implement Tool Framework (second tool + registration system)
