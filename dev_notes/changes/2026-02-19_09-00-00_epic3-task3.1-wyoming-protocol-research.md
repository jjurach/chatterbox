# Epic 3 Task 3.1: Wyoming Protocol Research and Documentation

**Status:** Completed
**Type:** ad-hoc (Research/Documentation)
**Date:** 2026-02-19
**Related Epic:** Epic 3 - Wyoming Protocol Implementation and Validation
**Related Plan:** dev_notes/project_plans/2026-02-18_epic-3-4-wyoming-llm-project-plan.md

---

## Summary

Completed Task 3.1 of Epic 3. Researched the Wyoming protocol implementation
already present in the codebase and created comprehensive reference documentation
at `docs/wyoming-protocol.md`.

This research revealed that a substantial Wyoming protocol implementation already
exists — including server, client, STT, and TTS components — but with important
gaps that must be addressed in subsequent Epic 3 tasks.

---

## Changes Made

### New File: `docs/wyoming-protocol.md`

Created comprehensive Wyoming protocol reference document covering:

- **Wire format** — JSON-over-TCP with binary payload for audio chunks
- **Event types** — `audio-start`, `audio-chunk`, `audio-stop`, `transcribe`,
  `transcript`, `synthesize`
- **Conversation flows** — STT-only, TTS-only, Full (STT+LLM+TTS), Combined
- **Server modes** — `full`, `stt_only`, `tts_only`, `combined`
- **Audio format requirements** — 16kHz S16_LE mono for STT; 22050Hz for TTS
- **Current implementation status** — what works, what doesn't
- **Protocol assumptions** — confirmed behaviors from code inspection
- **Dependencies** — `wyoming>=1.8.0`, `faster-whisper`, `piper-tts`, `pydub`
- **Test infrastructure** — `wyoming-tester` CLI and server runner
- **Epic 3 next steps** — clear list with critical blockers identified

---

## Research Findings

### Existing Implementation (already working)

- `wyoming>=1.8.0` installed; `AsyncServer` + `AsyncEventHandler` used correctly
- STT: `WhisperSTTService` (faster-whisper) — audio buffering + transcription functional
- Wyoming server: 4 modes (`full`, `stt_only`, `tts_only`, `combined`); port 10700
- Protocol client: `wyoming_tester/protocol.py` — TCP client with JSON/payload framing
- Test CLI: `wyoming-tester` — push-to-talk test with WAV files
- Server runner: `scripts/run-server.sh` — background process management

### Critical Gaps Discovered

| Gap | Impact |
|---|---|
| **TTS returns mock audio** — `PiperTTSService.synthesize()` returns `b'\x00' * 160` (MockPiperVoice) | Blocks Task 3.7 (TTS validation) and Task 3.8 (round-trip testing) |
| **No test wave corpus** | Blocks Tasks 3.4–3.8 |
| **No HA emulator with validation** | Blocks Tasks 3.6–3.8 |

---

## Verification

Research was conducted by reading source code directly. No runtime verification
was needed as this is a documentation-only task.

**Files inspected:**
- `src/chatterbox/adapters/wyoming/server.py` (622 lines)
- `src/chatterbox/adapters/wyoming/client.py` (405 lines)
- `src/wyoming_tester/protocol.py` (238 lines)
- `src/wyoming_tester/audio.py`
- `src/wyoming_tester/cli.py`
- `src/chatterbox/services/stt.py`
- `src/chatterbox/services/tts.py`
- `requirements.txt` and `pyproject.toml`
- `docs/testing-wyoming.md`
- `demos/wyoming_server.py`, `demos/wyoming_client_test.py`

---

## Known Issues

### TTS Mock Is a Critical Blocker

`PiperTTSService.synthesize()` currently returns placeholder bytes:

```python
# src/chatterbox/services/tts.py - MockPiperVoice
def synthesize(text, ...):
    return b'\x00' * 160  # Mock output
```

This must be fixed before any TTS validation (Task 3.7) or round-trip testing
(Task 3.8) can succeed. The fix requires wiring `PiperTTSService` to the actual
ONNX voice model rather than the mock.

**Recommended:** Address this as part of Task 3.4 (emulator core) or as a
prerequisite task before Task 3.7.

---

## Definition of Done Compliance

- [x] Documentation file created at `docs/wyoming-protocol.md`
- [x] Protocol documented: wire format, event types, conversation flows
- [x] Implementation status documented (what works, what's stubbed)
- [x] Critical blockers identified and recorded as Known Issues
- [x] File uses lowercase-kebab.md naming convention
- [x] Change log created with ad-hoc status
- [x] No code changes made (documentation only)

---

## Next Steps (Epic 3 Task 3.2)

Task 3.2 — Design Home Assistant Emulator Architecture — is now unblocked.

The existing `src/chatterbox/adapters/wyoming/client.py` (405 lines) provides
a starting point and should be evaluated during the architecture design phase.

**Priority before Task 3.7:** Fix the `MockPiperVoice` stub in
`src/chatterbox/services/tts.py` to use real Piper ONNX voice files.
