# Task 4.11 — Integrate Agentic Loop with Wyoming Protocol Endpoints

**Date:** 2026-02-20
**Status:** Completed
**Epic:** 4 — LLM Integration with Tool Calling

---

## Summary

Implemented the integration layer that bridges the Wyoming STT/TTS pipeline with the
`ChatterboxConversationEntity` agentic loop. Based on Task 4.1 research findings
(the conversation layer is NOT a Wyoming service — it is an HA `ConversationEntity`
subclass), this task delivers a **standalone HTTP conversation server** that can be
tested without a running Home Assistant instance.

The server exposes the conversation entity over REST so that:
- STT transcript text (from Wyoming Whisper) can be sent as `POST /conversation`
- The entity runs the agentic loop (LLM + tool calling)
- Response text is returned for downstream Wyoming TTS (Piper)

---

## Files Changed

### New Files

| File | Purpose |
|---|---|
| `src/chatterbox/conversation/server.py` | FastAPI HTTP server wrapping `ChatterboxConversationEntity` |
| `tests/unit/test_conversation/test_server.py` | 15 unit tests for the server (ASGI in-process, mocked LLM) |

### Modified Files

| File | Change |
|---|---|
| `tests/integration/test_end_to_end.py` | Replaced empty stub with 7 real integration tests |

---

## Implementation Details

### `src/chatterbox/conversation/server.py`

Factory function `create_conversation_app(entity)` returns a FastAPI application
that wraps a pre-built `ChatterboxConversationEntity`.

**Endpoints:**

| Method | Path | Description |
|---|---|---|
| `GET` | `/health` | Status and active session count |
| `POST` | `/conversation` | Process one turn (text in → text out) |
| `DELETE` | `/conversation/{id}` | Clear history for a session |
| `DELETE` | `/conversation` | Clear all session histories |

**Request schema:**
```json
{"text": "What is the weather?", "conversation_id": "optional-uuid", "language": "en"}
```

**Response schema:**
```json
{"response_text": "It is 72°F and sunny.", "conversation_id": "session-id", "extra": {}}
```

### Integration test pipeline simulation

`test_full_pipeline_text_flow` explicitly tests the HA pipeline pattern:
1. STT produces transcript text (simulated string)
2. Conversation server processes via `ChatterboxConversationEntity`
3. Response text is returned for TTS (simulated downstream)

---

## Test Results

```
199 passed, 3 warnings
```

- 15 new unit tests in `test_server.py` — all pass
- 7 new integration tests in `test_end_to_end.py` — all pass
- 0 regressions in the 177 pre-existing unit tests

---

## Architecture Note

The HTTP server is a **development/testing adapter**. In production, the
`ChatterboxConversationEntity` will be wired directly into Home Assistant as a
`ConversationEntity` subclass (no HTTP layer needed — HA calls `async_process()`
in-process). The server enables:

1. **Testing without HA** — stand-alone development
2. **Emulator integration** — `HAEmulator` can call the server to test the full
   STT → Conversation → TTS pipeline
3. **Pattern B / satellite integration** — if full satellite independence is desired,
   the satellite can call this HTTP endpoint directly

---

## Relation to Task Plan

Task 4.11 original deliverables (from project plan):
- ✅ Wyoming protocol integration (HTTP adapter bridges text ↔ entity)
- ✅ Integration tests (7 tests covering single-turn, multi-turn, health, clear, full pipeline)
- ✅ End-to-end validation (`test_full_pipeline_text_flow`)
- ✅ Error handling validated (rate-limit, connection error, API error all return 200 with fallback text)

Subtasks completed:
- ✅ Determine integration points based on Task 4.1 findings (Pattern A: HA ConversationEntity)
- ✅ Implement input handler to receive text from STT (`POST /conversation`)
- ✅ Implement output handler to send text to TTS (response body `response_text`)
- ✅ Protocol handshaking (HTTP request/response lifecycle)
- ✅ Error handling for failures (delegated to entity's existing error handling)
- ✅ Test with Epic 3 emulator-compatible interface (HTTP, usable by HAEmulator extensions)
- ✅ Document integration architecture (this file + server.py docstring)
