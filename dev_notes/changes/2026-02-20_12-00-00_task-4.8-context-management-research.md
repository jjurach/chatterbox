# Task 4.8 — Context Management Research & In-Memory Stub Enhancement

**Date:** 2026-02-20
**Status:** Completed
**Bead:** Task 4.8

---

## Summary

Researched context persistence options for `ChatterboxConversationEntity` and
decided to defer full persistent storage to Epic 5. Enhanced the existing
in-memory stub with two production-quality features: bounded history windows
(`max_history_turns`) and auto-creation of conversation session IDs
(`auto_create_conversation_id`). Created Epic 5 proposal document.

---

## Files Changed

### Modified

| File | Change |
|------|--------|
| `src/chatterbox/conversation/entity.py` | Added `max_history_turns`, `auto_create_conversation_id` params and `_truncate_history()` helper |
| `tests/unit/test_conversation/test_entity.py` | +11 tests covering truncation and auto-ID |

### Created

| File | Purpose |
|------|---------|
| `docs/context-management-research.md` | Research findings and Task 4.8 decision |
| `docs/epic5-context-persistence-proposal.md` | Scoped Epic 5 proposal for persistent storage |

---

## Decision Record

**Question:** Implement persistent context storage in Epic 4, or defer to Epic 5?

**Decision:** Defer to Epic 5.

**Rationale:**
- In-memory multi-turn history was already functional and tested.
- Persistent storage adds operational complexity (DB setup, schema, retention,
  privacy) that is out of scope for Epic 4's end-to-end validation goal.
- The `ConversationStore` protocol designed in the Epic 5 proposal will slot
  in cleanly — no public API change required.

---

## Code Changes Detail

### `max_history_turns` (default: 20)

Bounds the number of user+assistant turn pairs passed to the LLM. Prevents
unbounded token growth in long sessions. A turn limit of 20 (40 messages)
covers ~30 minutes of typical conversation at roughly 10 words per exchange.

Setting `max_history_turns=0` disables truncation for callers that manage
token budgets externally (e.g., integration tests, offline analysis).

### `auto_create_conversation_id` (default: False)

When `True`, a UUID4 session ID is generated if the caller omits
`conversation_id`. The ID is returned in `ConversationResult.conversation_id`
so the caller can track the session across turns. Useful for the HA pipeline
integration in Task 4.11 where session IDs originate inside the entity rather
than from HA.

Defaults to `False` to preserve the existing stateless single-turn behaviour.

---

## Test Results

```
tests/unit/test_conversation/test_entity.py  25/25 passed
tests/unit/  184/184 passed (no regressions)
```

---

## Next Task

Task 4.9 is skipped (persistence deferred). Next bead: **Task 4.10 — Context
Stub Completion** (mark stub interface as final; Epic 5 proposal already
written above). After that: **Task 4.11 — Wyoming Protocol Integration**.
