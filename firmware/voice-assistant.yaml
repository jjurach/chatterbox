---
external_components:
  - source:
      type: git
      url: https://github.com/muxa/esphome-state-machine.git
      ref: main

substitutions:
  name: esp32-s3-box-3
  friendly_name: ESP32 S3 Box 3
  loading_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/loading_320_240.png
  idle_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/idle_320_240.png
  listening_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/listening_320_240.png
  thinking_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/thinking_320_240.png
  replying_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/replying_320_240.png
  error_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/error_320_240.png
  timer_finished_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/timer_finished_320_240.png

  loading_illustration_background_color: "000000"
  idle_illustration_background_color: "000000"
  listening_illustration_background_color: "FFFFFF"
  thinking_illustration_background_color: "FFFFFF"
  replying_illustration_background_color: "FFFFFF"
  error_illustration_background_color: "000000"

  allowed_characters: " !#%'()+,-./0123456789:;<>?@ABCDEFGHIJKLMNOPQRSTUVWYZ[]_abcdefghijklmnopqrstuvwxyz{|}Â°Â²Â³ÂµÂ¿ÃÃ‚Ã„Ã…Ã‰Ã–ÃšÃŸÃ Ã¡Ã¢Ã£Ã¤Ã¥Ã¦Ã§Ã¨Ã©ÃªÃ«Ã¬Ã­Ã®Ã°Ã±Ã²Ã³Ã´ÃµÃ¶Ã¸Ã¹ÃºÃ»Ã¼Ã½Ã¾ÄÄƒÄ…Ä‡ÄÄÄÄ‘Ä“Ä—Ä™Ä›ÄŸÄ®Ä¯Ä±Ä¼Ä¾ÅÅ‚Å„ÅˆÅ‘Å™Å›Å¡Å¥Å©Å«Å¯Å±Å³ÅºÅ»Å¼Å½Å¾Æ¡Æ°È™È›Î†ÎˆÎŒÎÎ‘Î’Î“Î”Î•Î–Î—Î˜ÎšÎœÎÎ Î¡Î£Î¤Î¥Î¦Î¬Î­Î®Î¯Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏ‚ÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰ÏŠÏŒÏÏŽÐÐ‘Ð’Ð“Ð”Ð•Ð–Ð—Ð˜ÐšÐ›ÐœÐÐžÐŸÐ Ð¡Ð¢Ð£Ð¥Ð¦Ð§Ð¨ÐªÐ­Ð®Ð¯Ð°Ð±Ð²Ð³Ð´ÐµÐ¶Ð·Ð¸Ð¹ÐºÐ»Ð¼Ð½Ð¾Ð¿Ñ€ÑÑ‚ÑƒÑ„Ñ…Ñ†Ñ‡ÑˆÑ‰ÑŠÑ‹ÑŒÑÑŽÑÑ‘Ñ’Ñ”Ñ–Ñ—Ñ˜Ñ™ÑšÑ›××‘×’×“×”×•×–×—×˜×™×›×œ××ž×Ÿ× ×¡×¢×¤×¥×¦×§×¨×©×ªØŒØ¡Ø¢Ø£Ø¥Ø¦Ø§Ø¨Ø©ØªØ¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙ‰ÙŠÙ¹Ù¾Ú†ÚˆÚ©Ú¯ÚºÚ¾ÛÛŒÛ’à¦‚à¦•à¦šà¦¤à¦§à¦¨à¦«à¦¬à¦¯à¦°à¦²à¦¶à¦·à¦¸à¦¼à¦¾à¦¿à¥à§à°šà°¯à°²à°¿à±†à±Šà±à´‚à°…à´†à´‡à´ˆà´‰à´Žà´“à´•à´—à´™à´šà´œà´žà´Ÿà´¡à´£à´¤à´¦à´§à´¨à´ªà´«à´¬à´­à´®à´¯à´°à´±à´²à´³à´µà´¶à´¸à´¹à´¾à´¿àµ€àµàµ‚àµ†àµ‡àµˆàµàµºàµ»àµ¼àµ½àµ¾áƒáƒ‘áƒ’áƒ“áƒ”áƒ•áƒ–áƒ—áƒ˜áƒšáƒ›áƒœáƒáƒžáƒ áƒ¡áƒ¢áƒ£áƒ¤áƒ¥áƒ§áƒ¨áƒ©áƒªáƒ«áƒ­áƒ®áº¡áº£áº¥áº§áº©áº­áº¯áº·áº¹áº½áº¿á»á»ƒá»‡á»‰á»‹á»á»á»‘á»“á»•á»—á»™á»›á»á»Ÿá»£á»¥á»§á»©á»«á»­á»¯á»±á»³â€”ã€ä¸€ä¸Šä¸ä¸ªä¸­ä¸ºä¸»ä¹¾äº†äº›äº®äººä»»ä½Žä½”ä½•ä½œä¾›ä¾ä¾§ä¿‚å€‹å´åµå……å…‰å…¥å…¨å…³å†‡å†·å‡ åˆ‡åˆ°åˆ¶å‰å‹•å€å§åŽ…åŽ¨åŠå£å¦å³åŠåŽå—å¯å¸å‘€å’—å“ªå””å•å•Ÿå—Žå˜…å˜›å™¨åœåœ¨åœºåŸ·å ´å¤–å¤šå¤§å§‹å®‰å®šå®¢å®¤å®¶å¯†å¯µå¯¹å°‡å°å°‘å·¦å·²å¸˜å¸¸å¹«å¹¾åº“åº¦åº«å»Šå»šå»³å¼€å¼å¾Œæ†æ„Ÿæ…‹æˆæˆ‘æˆ²æˆ¶æˆ·æˆ¿æ‰€æ‰‡æ‰‹æ‰“æ‰§æŠŠæ‹”æ¢æŽ‰æŽ§æ’æ‘„æ•´æ–¯æ–°æ˜Žæ˜¯æ™¯æš—æ›´æœ€æœƒæœ‰æœªæœ¬æ¨¡æ©Ÿæª¯æ«ƒæ¬„æ¬¡æ­£æ°æ°´æ²’æ²¡æ´—æ´»æ´¾æ¸©æ¸¬æºæº«æ¼æ½®æ¿€æ¿•ç¯ç‚ºç„¡ç…™ç…§ç†±ç‡ˆç‡¥ç‰©ç‹€çŽ„çŽ°ç¾ç“¦ç”¨ç™¼çš„ç›žç›®ç€ç¡ç§ç©ºçª—ç«‹ç¬›ç®¡ç¯€ç°¾ç±¬ç´…ç·šçº¢ç½ç½®èšè²è„šè…¦è…³è‡¥è‰²èŠ‚è‘—è¡Œè¡£è§£è¨­èª¿è«‹è¬è­¦è®¾è°ƒèµ°è·¯è»Šè½¦è¿é€£éŠé‹éŽé“é‚Šéƒ¨éƒ½é‡éŽ–é”é–€é–‚é–‰é–‹é—œé—¨é—­é™¤éš±é›¢é›»éœ‡éœ§é¢éŸ³é ‚é¡Œé¡é¢œé¢¨é£Žé£Ÿé¤…é¤µê°€ê°„ê°ê°”ê°•ê°œê±°ê²Œê²¨ê²°ê²½ê³ ê³µê³¼ê´€ê·¸ê¸ˆê¸‰ê¸°ê¸¸ê¹¥êº¼ê»ê¼½ë‚˜ë‚œë‚´ë„¤ë†€ëˆ„ëŠ”ëŠ¥ë‹ˆë‹¤ë‹«ë‹´ëŒ€ë”ë°ë„ë™ëë˜ëœë¨ë‘¡ë“œë“ ë“±ë””ë•Œë–¤ëœ¨ë¼ëž˜ëŸ¬ë ‡ë Œë ¤ë¡œë£Œë¥¸ë¥¼ë¦¬ë¦¼ë§ë§ˆë§Žëª…ëª‡ëª¨ë¬´ë¬¸ë¬¼ë­ë°”ë°ë°©ë°°ë³€ë³´ë¶€ë¶ˆë¸”ë¹¨ë½‘ì‚¬ì‚°ìƒìƒ‰ì„œì„¤ì„±ì„¸ì„¼ì…˜ì†Œì‡¼ìˆ˜ìŠ¤ìŠµì‹œì‹ ì‹¤ì‹±ì•„ì•ˆì•Šì•Œì•˜ì• ì•¼ì–´ì–¼ì—…ì—†ì—ˆì—ì—¬ì—°ì—´ì˜†ì˜¤ì˜¨ì™„ì™¸ì™¼ìš”ìš´ì›€ì›Œì›ìœ„ìœ¼ì€ì„ìŒì˜ì´ì¸ì¼ìž„ìž…ìžˆìž‘ìž ìž¥ìž¬ì „ì ˆì •ì œì ¸ì¡°ì¡±ì¢…ì£¼ì¤„ì¤‘ì¤˜ì§€ì§ì§„ì§ìª½ì°¨ì°½ì²œìµœì¶”ì¶œì¶©ì¹˜ì¹¨ì»¤ì»´ì¼œì¼°ì¿ í¬í‚¤íƒíƒ„íƒœíƒ¬í„°í…”í†µíŠ¸íŠ¼í‹°íŒŒíŒ¬í¼í°í‘œí“¨í”Œí•‘í•œí•¨í•´í–ˆí–‰í˜€í˜„í™”í™œí›„íœ´íž˜ï¼Œï¼Ÿ"

  font_glyphsets: "GF_Latin_Core"
  font_family: Figtree

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  min_version: 2025.5.0
  name_add_mac_suffix: true
  on_boot:
    priority: 600
    then:
      - state_machine.transition:
          id: voice_assistant_fsm
          input: boot_successful

esp32:
  board: esp32s3box
  flash_size: 16MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"

psram:
  mode: octal
  speed: 80MHz

api:

ota:
  - platform: esphome
    id: ota_esphome

logger:
  hardware_uart: USB_SERIAL_JTAG
  level: DEBUG
  # Component-specific debug levels for observability
  logs:
    micro_wake_word: DEBUG
    voice_assistant: DEBUG
    state_machine: DEBUG
    i2s_audio: DEBUG
    microphone: DEBUG
    audio_adc: DEBUG
    media_player: DEBUG

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:

captive_portal:

button:
  - platform: factory_reset
    id: factory_reset_btn
    internal: true

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0
      mode: INPUT_PULLUP
      inverted: true
    id: left_top_button
    internal: true

output:
  - platform: ledc
    pin: GPIO47
    id: backlight_output

light:
  - platform: monochromatic
    id: led
    name: Screen
    icon: "mdi:television"
    entity_category: config
    output: backlight_output
    restore_mode: RESTORE_DEFAULT_ON
    default_transition_length: 250ms

i2c:
  scl: GPIO18
  sda: GPIO8

# touch_screen disabled - component not available in ESPHome 2025.12.6
# touch_screen:
#   - platform: gt911
#     id: my_touch_screen
#     interrupt_pin: GPIO21
#     on_touch:
#       then:
#         - lambda: |
#             // Check if touch is in the "Wake House" button area
#             // Button is centered at bottom: X: 80-240, Y: 200-230
#             if (touch.x > 80 && touch.x < 240 && touch.y > 200 && touch.y < 230) {
#               if (id(house_sleeping)) {
#                 id(wake_house).execute();
#               }
#             }

i2s_audio:
  - id: i2s_audio_bus
    i2s_lrclk_pin: GPIO45
    i2s_bclk_pin: GPIO17
    i2s_mclk_pin: GPIO2

audio_adc:
  - platform: es7210
    id: es7210_adc
    bits_per_sample: 16bit
    sample_rate: 16000

audio_dac:
  - platform: es8311
    id: es8311_dac
    bits_per_sample: 16bit
    sample_rate: 48000

microphone:
  - platform: i2s_audio
    id: box_mic
    sample_rate: 16000
    i2s_din_pin: GPIO16
    bits_per_sample: 16bit
    adc_type: external

speaker:
  - platform: i2s_audio
    id: box_speaker
    i2s_dout_pin: GPIO15
    dac_type: external
    sample_rate: 48000
    bits_per_sample: 16bit
    channel: left
    audio_dac: es8311_dac
    buffer_duration: 100ms

media_player:
  - platform: speaker
    name: None
    id: speaker_media_player
    volume_min: 0.5
    volume_max: 0.8
    announcement_pipeline:
      speaker: box_speaker
      format: FLAC
      sample_rate: 48000
      num_channels: 1
    files:
      - id: timer_finished_sound
        file: https://github.com/esphome/home-assistant-voice-pe/raw/dev/sounds/timer_finished.flac

micro_wake_word:
  id: mww
  models:
    - okay_nabu
    - hey_mycroft
    - hey_jarvis
  on_wake_word_detected:
    - logger.log:
        format: "ðŸŽ¤ WAKE WORD DETECTED!"
        level: INFO
    - state_machine.transition:
        id: voice_assistant_fsm
        input: wake_word_detected

voice_assistant:
  id: va
  microphone: box_mic
  media_player: speaker_media_player
  micro_wake_word: mww
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0
  on_stt_end:
    - logger.log:
        format: "ðŸ“ STT END event fired"
        level: INFO
    - state_machine.transition:
        id: voice_assistant_fsm
        input: stt_end
  on_tts_start:
    - logger.log:
        format: "ðŸ”Š TTS START event fired"
        level: INFO
    - state_machine.transition:
        id: voice_assistant_fsm
        input: tts_start
  on_tts_end:
    - logger.log:
        format: "ðŸ”‰ TTS END event fired"
        level: INFO
    - state_machine.transition:
        id: voice_assistant_fsm
        input: tts_end
  on_error:
    - logger.log:
        format: "âŒ VOICE ASSISTANT ERROR event fired"
        level: WARN
    - state_machine.transition:
        id: voice_assistant_fsm
        input: va_error
  on_client_connected:
    - logger.log:
        format: "âœ… Home Assistant CLIENT CONNECTED - voice assistant ready"
        level: INFO
    - state_machine.transition:
        id: voice_assistant_fsm
        input: boot_successful
  on_client_disconnected:
    - logger.log:
        format: "âš ï¸  Home Assistant CLIENT DISCONNECTED"
        level: WARN
    - state_machine.transition:
        id: voice_assistant_fsm
        input: va_error

switch:
  - platform: gpio
    name: Speaker Enable
    pin: GPIO46
    restore_mode: RESTORE_DEFAULT_ON
    entity_category: config
    disabled_by_default: true
  - platform: template
    name: Mute
    id: mute
    icon: "mdi:microphone-off"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
  - platform: template
    id: timer_ringing
    optimistic: true
    internal: true
    restore_mode: ALWAYS_OFF

select:
  - platform: template
    entity_category: config
    name: Wake word engine location
    id: wake_word_engine_location
    icon: "mdi:account-voice"
    optimistic: true
    restore_value: true
    options:
      - In Home Assistant
      - On device
    initial_option: On device

globals:
  - id: global_first_active_timer
    type: voice_assistant::Timer
    restore_value: false
  - id: global_is_timer_active
    type: bool
    restore_value: false
  - id: global_first_timer
    type: voice_assistant::Timer
    restore_value: false
  - id: global_is_timer
    type: bool
    restore_value: false

state_machine:
  id: voice_assistant_fsm
  initial_state: uninitialized
  states:
    - name: uninitialized
      on_enter:
        - logger.log:
            format: "ðŸ”„ STATE MACHINE â†’ UNINITIALIZED"
            level: INFO
        - display.page.show: uninitialized_page
    - name: idle
      on_enter:
        - logger.log:
            format: "ðŸ˜´ STATE MACHINE â†’ IDLE (ready for wake word)"
            level: INFO
        - display.page.show: idle_page
    - name: listening
      on_enter:
        - logger.log:
            format: "ðŸ‘‚ STATE MACHINE â†’ LISTENING (recording speech)"
            level: INFO
        - display.page.show: listening_page
    - name: thinking
      on_enter:
        - logger.log:
            format: "ðŸ§  STATE MACHINE â†’ THINKING (processing)"
            level: INFO
        - display.page.show: thinking_page
    - name: replying
      on_enter:
        - logger.log:
            format: "ðŸ—£ï¸  STATE MACHINE â†’ REPLYING (speaking response)"
            level: INFO
        - display.page.show: replying_page
    - name: error
      on_enter:
        - logger.log:
            format: "ðŸ’¥ STATE MACHINE â†’ ERROR (something failed)"
            level: ERROR
        - display.page.show: error_page
  inputs:
    - name: boot_successful
      transitions:
        - from: uninitialized
          to: idle
    - name: wake_word_detected
      transitions:
        - from: idle
          to: listening
    - name: stt_end
      transitions:
        - from: listening
          to: thinking
    - name: tts_start
      transitions:
        - from: thinking
          to: replying
    - name: tts_end
      transitions:
        - from: replying
          to: idle
    - name: silence_detected
      transitions:
        - from: listening
          to: idle
    - name: va_error
      transitions:
        - from: thinking
          to: error
        - from: replying
          to: error
        - from: listening
          to: error
        - from: idle
          to: error
    - name: error_cleared
      transitions:
        - from: error
          to: idle

image:
  - file: ${error_illustration_file}
    id: casita_error
    resize: 320x240
    type: RGB
    transparency: alpha_channel
  - file: ${idle_illustration_file}
    id: casita_idle
    resize: 320x240
    type: RGB
    transparency: alpha_channel
  - file: ${listening_illustration_file}
    id: casita_listening
    resize: 320x240
    type: RGB
    transparency: alpha_channel
  - file: ${thinking_illustration_file}
    id: casita_thinking
    resize: 320x240
    type: RGB
    transparency: alpha_channel
  - file: ${replying_illustration_file}
    id: casita_replying
    resize: 320x240
    type: RGB
    transparency: alpha_channel
  - file: ${timer_finished_illustration_file}
    id: casita_timer_finished
    resize: 320x240
    type: RGB
    transparency: alpha_channel
  - file: ${loading_illustration_file}
    id: casita_initializing
    resize: 320x240
    type: RGB
    transparency: alpha_channel
  - file: https://github.com/esphome/wake-word-voice-assistants/raw/main/error_box_illustrations/error-no-wifi.png
    id: error_no_wifi
    resize: 320x240
    type: RGB
    transparency: alpha_channel
  - file: https://github.com/esphome/wake-word-voice-assistants/raw/main/error_box_illustrations/error-no-ha.png
    id: error_no_ha
    resize: 320x240
    type: RGB
    transparency: alpha_channel

font:
  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
      italic: true
    id: font_request
    size: 15
    glyphsets:
      - ${font_glyphsets}
  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: font_response
    size: 15
    glyphsets:
      - ${font_glyphsets}
  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: font_timer
    size: 30
    glyphsets:
      - ${font_glyphsets}

text_sensor:
  - id: text_request
    platform: template
    on_value:
      lambda: |-
        if(id(text_request).state.length()>32) {
          std::string name = id(text_request).state.c_str();
          std::string truncated = esphome::str_truncate(name.c_str(),31);
          id(text_request).state = (truncated+"...").c_str();
        }

  - id: text_response
    platform: template
    on_value:
      lambda: |-
        if(id(text_response).state.length()>32) {
          std::string name = id(text_response).state.c_str();
          std::string truncated = esphome::str_truncate(name.c_str(),31);
          id(text_response).state = (truncated+"...").c_str();
        }

color:
  - id: idle_color
    hex: ${idle_illustration_background_color}
  - id: listening_color
    hex: ${listening_illustration_background_color}
  - id: thinking_color
    hex: ${thinking_illustration_background_color}
  - id: replying_color
    hex: ${replying_illustration_background_color}
  - id: loading_color
    hex: ${loading_illustration_background_color}
  - id: error_color
    hex: ${error_illustration_background_color}
  - id: active_timer_color
    hex: "26ed3a"
  - id: paused_timer_color
    hex: "3b89e3"

spi:
  - id: spi_bus
    clk_pin: 7
    mosi_pin: 6

display:
  - platform: ili9xxx
    id: s3_box_lcd
    model: S3BOX
    invert_colors: false
    data_rate: 40MHz
    cs_pin: 5
    dc_pin: 4
    reset_pin:
      number: 48
      inverted: true
    update_interval: 1s
    on_page_change:
      then:
        - component.update: s3_box_lcd
    pages:
      - id: uninitialized_page
        lambda: |-
          it.image((it.get_width() / 2), (it.get_height() / 2), id(casita_initializing), ImageAlign::CENTER);
      - id: idle_page
        lambda: |-
          it.image((it.get_width() / 2), (it.get_height() / 2), id(casita_idle), ImageAlign::CENTER);
      - id: listening_page
        lambda: |-
          it.image((it.get_width() / 2), (it.get_height() / 2), id(casita_listening), ImageAlign::CENTER);
      - id: thinking_page
        lambda: |-
          it.image((it.get_width() / 2), (it.get_height() / 2), id(casita_thinking), ImageAlign::CENTER);
      - id: replying_page
        lambda: |-
          it.image((it.get_width() / 2), (it.get_height() / 2), id(casita_replying), ImageAlign::CENTER);
      - id: error_page
        lambda: |-
          it.image((it.get_width() / 2), (it.get_height() / 2), id(casita_error), ImageAlign::CENTER);
